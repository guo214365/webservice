# AI家庭医生 - 新功能使用指南

## 功能概览

项目已成功升级，实现了以下新功能：

### 1️⃣ 左侧历史记录面板
位置在页面左侧，显示最近的15轮对话记录。

**功能操作：**
- 👆 **点击对话项** - 切换到该对话
- 🗑️ **悬停后点击×** - 删除单个对话
- 🗑️ **点击右上角垃圾桶** - 清空所有历史记录

### 2️⃣ 页面内容可复制
每条AI回复下都有操作按钮。

**操作方式：**
- 📋 **复制** - 复制纯文本内容（自动去除Markdown标记）
- 👍 **点赞** - 标记有用的回复
- 📤 **分享** - 分享对话内容

### 3️⃣ 导出对话功能
在输入框上方新增导出按钮。

**导出格式：**
- 📄 **JSON格式** - 包含完整结构化数据
  ```json
  {
    "title": "对话标题",
    "timestamp": "2026-01-29T12:34:56.789Z",
    "messages": [...]
  }
  ```

- 📝 **Markdown格式** - 格式化文本，便于阅读和分享
  ```markdown
  # 对话记录
  
  **导出时间:** 2026-01-29 20:34:56
  
  ---
  
  ## 用户
  
  有什么健康问题尽管问我
  
  ---
  
  ## AI助手
  
  我是AI家庭医生...
  ```

### 4️⃣ 自动历史保存
- ✅ 所有对话自动保存到浏览器本地存储
- 📊 每条消息都被记录
- 🔄 页面刷新后仍可恢复所有对话
- ⏱️ 对话标题自动生成（取第一条消息的前30个字符）

### 5️⃣ 新建对话
点击右上角的"＋"按钮可以创建全新对话。

## 使用步骤

### 基础聊天流程
1. 在输入框中输入问题
2. 按Enter发送或点击发送按钮
3. AI回复会实时显示
4. 对话自动保存到历史记录

### 切换历史对话
1. 在左侧面板选择要切换的对话
2. 该对话所有消息会加载到主区域
3. 点击新对话继续输入

### 复制AI回复
1. 找到要复制的AI消息
2. 点击下方的"复制"按钮
3. 系统会自动复制纯文本内容
4. 按钮显示"已复制"表示成功（2秒后恢复）

### 导出完整对话
1. 点击输入框上方的导出按钮（📥）
2. 在弹窗中选择导出格式
   - 输入 `1` 选择JSON格式
   - 输入 `2` 选择Markdown格式
3. 文件会自动下载到默认下载文件夹

## 技术细节

### 数据存储
- **存储方式** - 浏览器的 localStorage API
- **存储容量** - 通常5-10MB（不同浏览器略有差异）
- **存储键** - `chatHistories`
- **持久化** - 不同标签页可共享数据

### 历史记录限制
- **最多保存** - 15轮对话
- **超出限制** - 自动删除最旧的对话
- **可修改** - 修改JS中的 `maxHistories` 常量

### 消息结构
```javascript
{
  id: "1706518496000",          // 对话ID（时间戳）
  title: "有什么健康问题...",    // 对话标题
  timestamp: "2026-01-29 ...",  // 创建时间
  messages: [                    // 消息列表
    { role: "user", content: "..." },
    { role: "assistant", content: "..." }
  ]
}
```

## 新增按钮说明

### 导出按钮
位置：输入框上方，图标为💾
- 支持JSON和Markdown两种格式
- 自动处理文件下载
- 导出文件名格式：`chat_[时间戳].json` 或 `.md`

### 清空历史按钮
位置：左侧面板顶部，图标为🗑️
- 一键清空所有历史记录
- 需要确认，防止误操作
- 清空后会自动创建新对话

## 浏览器兼容性

✅ **完全支持**
- Chrome 63+
- Firefox 53+
- Safari 13.1+
- Edge 79+

⚠️ **部分功能**
- IE 11（不支持复制功能）

## 常见问题

### Q: 历史记录会被同步吗？
**A:** 不会。历史记录只存储在本浏览器中，不同浏览器/设备无法同步。如需同步，请使用导出功能备份。

### Q: 复制功能复制的是什么？
**A:** 复制的是去除Markdown标记的纯文本，更便于粘贴和分享。

### Q: 导出的文件在哪里？
**A:** 文件保存在浏览器的默认下载文件夹（通常是 Downloads 文件夹）。

### Q: 能修改历史记录的数量限制吗？
**A:** 可以。修改 `app_ws.js` 中的 `this.maxHistories = 15` 即可。

### Q: localStorage满了怎么办？
**A:** 系统会自动保留最新的15轮对话。可以手动删除不需要的对话或导出后清空。

### Q: 能恢复已删除的对话吗？
**A:** 不能。删除是永久的。如需保存，请先导出再删除。

## 快捷键

- **Enter** - 发送消息
- **Shift + Enter** - 换行（不发送）

## 页面布局

```
┌─────────────────────────────────────────────────┐
│  左侧面板  │           主内容区域                │
│ (250px)  │                                      │
│           │  [状态] [标题] [+新建]              │
│ 历史记录  │  ────────────────────────           │
│ 列表      │                                      │
│ (15条)    │  消息显示区域                       │
│           │  (可滚动)                           │
│  ─────    │  ────────────────────────           │
│  🗑清空   │  [📷] [📄] [💾] [发送]              │
│           │  输入框                             │
└─────────────────────────────────────────────────┘
```

## 响应式设计

- **桌面版** (>900px) - 左侧250px固定宽度边栏
- **平板版** (600-900px) - 左侧200px边栏
- **手机版** (<600px) - 上下布局，历史面板变为200px高的滚动条

## 隐私说明

- ✅ 所有数据存储在本地浏览器
- ✅ 不会上传到服务器
- ✅ 清除浏览器缓存时会自动删除
- ✅ 支持离线使用

## 性能优化

- 📊 只保留最新15轮对话（自动清理过期数据）
- ⚡ 每次保存使用 localStorage（快速操作）
- 🎯 导出时进行流式处理（大文件也不会卡顿）
- 🔄 历史列表动态渲染（加载快）

## 反馈和建议

如有功能建议或问题，可以：
1. 查看浏览器开发者工具的Console查看错误信息
2. 检查 localStorage 存储的数据大小
3. 尝试清除浏览器缓存重新开始

---

**版本**: 2.0  
**更新日期**: 2026-01-29  
**主要更新**: 添加历史记录、导出功能和改进的复制机制

